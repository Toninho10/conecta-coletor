<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coletor QR ‚Üí Planilha (Mobile) ‚Äî Conecta Ind√∫stria 2025</title>
  <style>
    :root { --bg:#0b0d10; --fg:#eef2f6; --muted:#9aa4b2; --acc:#6ee7b7; --bad:#f87171; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:16px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial}
    .wrap{max-width:920px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0 0 12px}
    .card{background:#11151a;border:1px solid #1f2833;border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 2px 14px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{border:0;border-radius:12px;padding:10px 14px;background:#1a212b;color:var(--fg);font-weight:600}
    button.primary{background:var(--acc);color:#042016}
    button.warn{background:var(--bad);color:#220808}
    label{font-size:13px;color:var(--muted)}
    input[type="text"], input[type="url"], textarea{width:100%;border:1px solid #1f2833;background:#0d1116;color:var(--fg);border-radius:10px;padding:10px}
    small{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){.grid{grid-template-columns:1fr}}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#0d1116;border:1px solid #1f2833;border-radius:999px;padding:6px 10px}
    .ok{color:var(--acc)} .err{color:var(--bad)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .mt8{margin-top:8px} .mt12{margin-top:12px}
    video{width:100%;max-height:40vh;border-radius:10px;background:#000}
    canvas{display:none}
    table{width:100%;border-collapse:collapse}
    td,th{border-bottom:1px solid #1f2833;padding:8px;text-align:left}
    kbd{background:#0d1116;border:1px solid #1f2833;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>üì≤ Coletor QR ‚Üí Planilha (Mobile) ‚Äî Conecta Ind√∫stria 2025</h1>
  <div class="card">
    <div class="grid">
      <div>
        <label>Webhook de Coleta (Make) ‚Äî obrigat√≥rio</label>
        <input id="webhook" type="url" placeholder="https://hook.eu1.make.com/xxxxx" />
        <small>Recebe cada leitura e grava na planilha.</small>
      </div>
      <div>
        <label>Webhook de Finaliza√ß√£o (Make) ‚Äî opcional</label>
        <input id="webhookFinalize" type="url" placeholder="https://hook.eu1.make.com/yyyyy" />
        <small>Quando tocar em "Finalizar & Enviar", o Make exporta e manda o banco por e-mail.</small>
      </div>
    </div>
    <div class="grid mt12">
      <div>
        <label>Evento (ID/nome curto)</label>
        <input id="eventId" type="text" placeholder="ex.: 2025-sympla-techday" />
        <small>Vai junto em cada leitura para filtrar no relat√≥rio.</small>
      </div>
      <div>
        <label>Stand/Empresa Expositora</label>
        <input id="standId" type="text" placeholder="ex.: ACME-Stand-01" />
        <small>Identifica qual stand coletou (√∫til para dividir leads).</small>
      </div>
    </div>
    <div class="grid mt12">
      <div>
        <label>E‚Äëmail do respons√°vel (destino do resumo) ‚Äî <b>opcional</b></label>
        <input id="emailResumo" type="text" placeholder="(deixe vazio para usar o e‚Äëmail oficial da Config)" />
        <small>Se vazio, o backend busca o e‚Äëmail oficial cadastrado para o stand.</small>
      </div>
      
    </div>
    <div class="row mt12">
      <label class="pill"><input id="autosave" type="checkbox" checked/> Autossalvar cada leitura no Make</label>
      <label class="pill"><input id="haptics" type="checkbox" checked/> Vibra√ß√£o curta ao ler</label>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <button class="primary" id="btnStart">‚ñ∂Ô∏è Iniciar c√¢mera</button>
      <button id="btnStop">‚èπÔ∏è Parar</button>
      <button id="btnManual">‚å®Ô∏è Inserir manual</button>
      <button id="btnFinalize" class="warn">üì§ Finalizar & Enviar</button>
      <div id="support" class="mt8"></div>
    </div>
    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>
    <div class="row mt12">
      <span id="status" class="pill">Pronto.</span>
      <span id="detApi" class="pill">Detector: <b class="mono">‚Äî</b></span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">√öltima leitura</h3>
    <div id="lastRaw" class="mono" style="white-space:pre-wrap"></div>
    <div id="kv"></div>
    <div class="row mt12">
      <button id="btnSave" class="primary">üíæ Salvar no Make</button>
      
      <button id="btnCSV">‚¨áÔ∏è Exportar CSV (local)</button>
      <small id="hint" class="mt8"></small>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0">Hist√≥rico local (somente sess√£o)</h3>
    <table id="tbl"><thead><tr><th>#</th><th>Hor√°rio</th><th>Conte√∫do</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card">
    <small>
      Dica: instale na tela inicial (<kbd>‚ãÆ</kbd> ‚Üí <b>Adicionar √† tela inicial</b>). Requer HTTPS para c√¢mera (ex.: Netlify/GitHub Pages).
    </small>
  </div>
</div>

<script>
(function(){
  const el = id => document.getElementById(id);
  const video = el('video');
  const canvas = el('canvas');
  const ctx = canvas.getContext('2d');
  const status = el('status');
  const detApi = el('detApi').querySelector('b');
  const lastRaw = el('lastRaw');
  const kv = el('kv');
  const tblBody = document.querySelector('#tbl tbody');
  const webhook = el('webhook');
  const webhookFinalize = el('webhookFinalize');
  const eventId = el('eventId');
  const standId = el('standId');
  const emailResumo = el('emailResumo');
  const autosave = el('autosave');
  const haptics = el('haptics');
  // const whats = el('whats'); // removido
  const support = el('support');
// Avisos √∫teis (HTTPS / iframe / suporte)
if (!window.isSecureContext) {
  support.innerHTML = '<small class="err">Para usar a c√¢mera, abra via <b>HTTPS</b> (ex.: Netlify/GitHub Pages). <code>http://</code> e <code>file://</code> bloqueiam a c√¢mera.</small>';
}
if (window.self !== window.top) {
  const a = document.createElement('a');
  a.href = location.href; a.target = '_blank';
  a.textContent = 'Abrir em nova aba (sair de iframe)';
  const tip = document.createElement('small'); tip.style.display = 'block';
  tip.appendChild(a); support.appendChild(tip);
}
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
  support.innerHTML += '<small class="err">Navegador sem suporte a <b>getUserMedia</b>. Atualize o Chrome/Edge/Safari.</small>';
}

  // Persistir config
  const saved = JSON.parse(localStorage.getItem('qr_cfg')||'{}');
  // Prefill por query string (event, stand, w1, w2) e bloqueio opcional
  const qs = new URLSearchParams(location.search);
  if(qs.get('event')) saved.eventId = qs.get('event');
  if(qs.get('stand')) saved.standId = qs.get('stand');
  if(qs.get('w1')) saved.webhook = qs.get('w1');
  if(qs.get('w2')) saved.webhookFinalize = qs.get('w2');
  const lockInputs = qs.get('lock') === '1';
  ['webhook','webhookFinalize','eventId','standId','emailResumo','autosave'].forEach(k=>{
    if(saved[k]!==undefined){ (k==='autosave'? autosave.checked = !!saved[k] : el(k).value = saved[k]); }
  // Valor padr√£o do evento se vazio
  if(!eventId.value) eventId.value = 'Conecta Ind√∫stria 2025';
  if(lockInputs){ ['webhook','webhookFinalize','eventId','standId'].forEach(id=>{ const x=el(id); if(x) { x.readOnly = true; x.style.opacity = 0.7; } }); }
  });
 function saveCfg(){ localStorage.setItem('qr_cfg', JSON.stringify({
 	 webhook: webhook.value.trim(),
  	webhookFinalize: webhookFinalize.value.trim(),
  	eventId: eventId.value.trim(),
 	 standId: standId.value.trim(),
  	emailResumo: emailResumo.value.trim(),
  	autosave: autosave.checked
})); }

  ;['change','keyup'].forEach(ev=>{ [webhook, webhookFinalize, eventId, standId, emailResumo].forEach(x=>x.addEventListener(ev, saveCfg)); autosave.addEventListener('change', saveCfg); });

  // Detector
  let detector = null;
  let useBarcodeDetector = 'BarcodeDetector' in window;
  if(useBarcodeDetector){
    try{ detector = new BarcodeDetector({formats:['qr_code']}); detApi.textContent = 'BarcodeDetector'; }
    catch(e){ useBarcodeDetector = false; detApi.textContent = '‚Äî'; }
  } else { detApi.textContent = '‚Äî'; }
  if(!useBarcodeDetector){ support.innerHTML = '<small class="err">Seu navegador n√£o tem <b>BarcodeDetector</b>. Use <b>Inserir manual</b> ou atualize o Chrome/Edge. </small>'; }

  let stream = null, scanning = false, seenSet = new Set();
  function setStatus(msg, ok=true){ status.textContent = msg; status.className = ok? 'pill ok' : 'pill err'; }

  async function start(){
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio: false });
      video.srcObject = stream; await video.play(); scanning = true; loop(); setStatus('C√¢mera ativa.');
    } catch(e){ setStatus('Falha ao abrir c√¢mera: '+ e.message, false); }
  }
  function stop(){ scanning=false; if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } setStatus('Parado.'); }

  async function loop(){
    if(!scanning) return;
    if(video.readyState >= 2){
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      if(useBarcodeDetector && detector){
        try{
          const codes = await detector.detect(canvas);
          if(codes && codes.length){ handleRead(codes[0].rawValue); return; }
        }catch(e){ /* noop */ }
      }
    }
    requestAnimationFrame(loop);
  }

  function vibrate(ms=40){ if(haptics.checked && 'vibrate' in navigator) navigator.vibrate(ms); }

  function parsePayload(text){
  const s = String(text).trim();

  // 0) Linhas "Chave: Valor" (cada campo em uma linha)
  if (s.includes(':') && (s.includes('\n') || s.includes('\r'))) {
    const obj = {};
    s.split(/\r?\n/).forEach(line => {
      let t = String(line).trim();
      if (!t) return;
      t = t.replace(/^[-‚Ä¢*]\s*/, ''); // remove marcadores
      const i = t.indexOf(':');
      if (i > 0) {
        const key = t.slice(0, i).trim();
        const val = t.slice(i + 1).trim();
        if (key) obj[key] = val;
      }
    });
    if (Object.keys(obj).length) return obj;
  }

  // 1) JSON
  try {
    if((s.startsWith('{') && s.endsWith('}')) || (s.startsWith('[') && s.endsWith(']'))) {
      const o = JSON.parse(s);
      if (o && typeof o === 'object' && !Array.isArray(o)) return o;
    }
  } catch {}

  // 2) URL com query
  try {
    const u = new URL(s);
    if (u.search) {
      const obj = {};
      u.searchParams.forEach((v,k)=>obj[k]=v);
      return obj;
    }
  } catch {}

  // 3) a=1&b=2 ou a=1;b=2
  if (s.includes('=') && (s.includes('&') || s.includes(';'))) {
    const obj = {};
    s.split(/[;&]/).forEach(p=>{
      const i = p.indexOf('=');
      if (i > 0) obj[p.slice(0,i).trim()] = p.slice(i+1).trim();
    });
    if (Object.keys(obj).length) return obj;
  }

  // 4) a:1; b:2 | a:1 | b:2
  if (s.includes(':') && (s.includes(';') || s.includes('|'))) {
    const obj = {};
    s.split(/[;|]/).forEach(p=>{
      const i = p.indexOf(':');
      if (i > 0) obj[p.slice(0,i).trim()] = p.slice(i+1).trim();
    });
    if (Object.keys(obj).length) return obj;
  }

  return {};
}

  function normalizeKey(k){
    k = (k||'').toString().trim().toLowerCase();
    k = k.normalize('NFD').replace(/\p{Diacritic}/gu,''); // remove acentos
    k = k.replace(/[^a-z0-9]/g,''); // remove s√≠mbolos
    return k;
  }
  function unifyFields(fields){
    const f = {}; const map = {};
    for(const [k,v] of Object.entries(fields||{})) map[normalizeKey(k)] = String(v);
    // Sin√¥nimos
    f.nome = map.nome || map.name || '';
    f.cargo = map.cargo || map.role || map.funcao || '';
    f.empresa = map.empresa || map.company || '';
    f.telefone = map.telefone || map.phone || map.celular || map.mobile || map.tel || '';
    f.email = map.email || map.emailaddress || map.mail || map.e || map.e_mail || '';
    return f;
  }

  let lastObj = null;
  function detectSource(raw){ return /sympla/i.test(raw) ? 'sympla' : 'custom'; }
  function handleRead(raw){
    if(!raw) return; if(seenSet.has(raw)) { setStatus('Lido (duplicado).', false); vibrate(10); return; }
    seenSet.add(raw); vibrate();
    const when = new Date();
    const fields = parsePayload(raw);
    const uf = unifyFields(fields);
    lastObj = {
      timestamp: when.toISOString().slice(0,19).replace('T',' '),
      raw,
      event_id: eventId.value.trim()||'',
      stand_id: standId.value.trim()||'',
      source: detectSource(raw),
      nome: uf.nome, cargo: uf.cargo, empresa: uf.empresa, telefone: uf.telefone, email: uf.email,
      fields // mant√©m original para auditoria
    };
    lastRaw.textContent = raw;
    renderKV(uf);
    appendRow(when, uf);
    setStatus('QR lido.');
    if(autosave.checked) saveToMake(lastObj);
  }

  function renderKV(fields){
    kv.innerHTML = '';
    const keys = Object.keys(fields);
    if(!keys.length){ kv.innerHTML = '<small class="muted">(Sem chaves detectadas ‚Äî ser√° salvo apenas o texto bruto.)</small>'; return; }
    const table = document.createElement('table');
    const tb = document.createElement('tbody'); table.appendChild(tb);
    const order = ['nome','cargo','empresa','telefone','email', ...keys.filter(k=>!['nome','cargo','empresa','telefone','email'].includes(k))];
    order.forEach(k=>{
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.textContent = k; td1.style.color='var(--muted)';
      const td2 = document.createElement('td'); td2.textContent = fields[k]||''; td2.className='mono';
      tr.appendChild(td1); tr.appendChild(td2); tb.appendChild(tr);
    });
    kv.appendChild(table);
  }

  function appendRow(date, uf){
    const tr = document.createElement('tr');
    const n = tblBody.children.length + 1;
    const preview = [uf.nome||'', uf.email||'', uf.empresa||''].filter(Boolean).join(' ‚Ä¢ ');
    tr.innerHTML = `<td>${n}</td><td>${date.toLocaleTimeString()}</td><td class="mono">${escapeHtml(preview).slice(0,160)}</td>`;
    tblBody.prepend(tr);
  }

  function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

  async function saveToMake(obj){
    const url = webhook.value.trim(); if(!url){ setStatus('Cole o Webhook de Coleta.', false); return; }
    try{ const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(obj)}); if(!res.ok) throw new Error('HTTP '+res.status); setStatus('Salvo no Make.'); }
    catch(e){ setStatus('Falha no envio: '+e.message, false); }
  }

  async function finalizeAndSend(){
    const url = webhookFinalize.value.trim(); if(!url){ setStatus('Configure o Webhook de Finaliza√ß√£o.', false); return; }
    const eid = eventId.value.trim(); if(!eid){ setStatus('Preencha o Evento.', false); return; }
    const to = emailResumo.value.trim(); // opcional: se vazio, backend usa a planilha Config
    const payload = { event_id: eid, stand_id: stand };
    if (to) payload.to_email = to;
    const stand = standId.value.trim();
    try{
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ event_id: eid, stand_id: stand, to_email: to }) });
      if(!res.ok) throw new Error('HTTP '+res.status);
      setStatus('Resumo solicitado. Verifique o e‚Äëmail.');
    }catch(e){ setStatus('Falha na finaliza√ß√£o: '+e.message, false); }
  }

    function shareEmail(){
    if(!lastObj){ setStatus('Nada para enviar.', false); return; }
    const subject = encodeURIComponent('Leitura de QR');
    const body = encodeURIComponent(
      `Evento: ${lastObj.event_id||'-'}\nStand: ${lastObj.stand_id||'-'}\nHor√°rio: ${lastObj.timestamp}\n\n`+
      `Nome: ${lastObj.nome||''}\nCargo: ${lastObj.cargo||''}\nEmpresa: ${lastObj.empresa||''}\nTelefone: ${lastObj.telefone||''}\nE‚Äëmail: ${lastObj.email||''}`
    );
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  }

  function exportCSV(){
    if(!lastObj){ setStatus('Realize ao menos uma leitura.', false); return; }
    const rows = [["timestamp","evento","stand","source","nome","cargo","empresa","telefone","email","raw" ]];
    rows.push([lastObj.timestamp, lastObj.event_id||'', lastObj.stand_id||'', lastObj.source||'', lastObj.nome||'', lastObj.cargo||'', lastObj.empresa||'', lastObj.telefone||'', lastObj.email||'', lastObj.raw]);
    const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `leituras_${(eventId.value||'evento')}.csv`; a.click(); URL.revokeObjectURL(a.href);
  }

  // UI bindings
  document.getElementById('btnStart').addEventListener('click', start);
  document.getElementById('btnStop').addEventListener('click', stop);
  document.getElementById('btnManual').addEventListener('click', ()=>{ const raw = prompt('Cole ou digite o conte√∫do do QR:'); if(raw) handleRead(raw); });
  document.getElementById('btnSave').addEventListener('click', ()=> lastObj && saveToMake(lastObj));
      document.getElementById('btnCSV').addEventListener('click', exportCSV);
  document.getElementById('btnFinalize').addEventListener('click', finalizeAndSend);
})();
</script>
</body>
</html>
